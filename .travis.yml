language: node_js
node_js:
 - "4.2"
services:
 - mongodb
addons:
 hosts:
  - qili.server
  - qili.db
 apt:
  packages:
   - sshpass

before_script:
 - mkdir test
 - mkdir test/data
 - mkdir test/data/apps
 - sleep 5
 - npm start &
 - sleep 2

script:
 - npm test
 - sshpass -e ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $DEPLOY_USER@$DEPLOY_HOST "cd $TARGET_REPOSITORY_PATH && git pull && cd deploy && $TARGET_DOCKER_ENVS docker-compose restart"
